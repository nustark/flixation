{"ast":null,"code":"import _classCallCheck from \"/Users/thurman/CS/React/streams/client/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/thurman/CS/React/streams/client/node_modules/@babel/runtime/helpers/esm/createClass\";\n\n/*\n * Copyright (C) 2016 Bilibili. All Rights Reserved.\n *\n * @author zheng qian <xqq@xqq.im>\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport EventEmitter from 'events';\nimport PlayerEvents from './player-events.js';\nimport { createDefaultConfig } from '../config.js';\nimport { InvalidArgumentException, IllegalStateException } from '../utils/exception.js'; // Player wrapper for browser's native player (HTMLVideoElement) without MediaSource src. \n\nvar NativePlayer =\n/*#__PURE__*/\nfunction () {\n  function NativePlayer(mediaDataSource, config) {\n    _classCallCheck(this, NativePlayer);\n\n    this.TAG = 'NativePlayer';\n    this._type = 'NativePlayer';\n    this._emitter = new EventEmitter();\n    this._config = createDefaultConfig();\n\n    if (typeof config === 'object') {\n      Object.assign(this._config, config);\n    }\n\n    if (mediaDataSource.type.toLowerCase() === 'flv') {\n      throw new InvalidArgumentException('NativePlayer does\\'t support flv MediaDataSource input!');\n    }\n\n    if (mediaDataSource.hasOwnProperty('segments')) {\n      throw new InvalidArgumentException(\"NativePlayer(\".concat(mediaDataSource.type, \") doesn't support multipart playback!\"));\n    }\n\n    this.e = {\n      onvLoadedMetadata: this._onvLoadedMetadata.bind(this)\n    };\n    this._pendingSeekTime = null;\n    this._statisticsReporter = null;\n    this._mediaDataSource = mediaDataSource;\n    this._mediaElement = null;\n  }\n\n  _createClass(NativePlayer, [{\n    key: \"destroy\",\n    value: function destroy() {\n      if (this._mediaElement) {\n        this.unload();\n        this.detachMediaElement();\n      }\n\n      this.e = null;\n      this._mediaDataSource = null;\n\n      this._emitter.removeAllListeners();\n\n      this._emitter = null;\n    }\n  }, {\n    key: \"on\",\n    value: function on(event, listener) {\n      var _this = this;\n\n      if (event === PlayerEvents.MEDIA_INFO) {\n        if (this._mediaElement != null && this._mediaElement.readyState !== 0) {\n          // HAVE_NOTHING\n          Promise.resolve().then(function () {\n            _this._emitter.emit(PlayerEvents.MEDIA_INFO, _this.mediaInfo);\n          });\n        }\n      } else if (event === PlayerEvents.STATISTICS_INFO) {\n        if (this._mediaElement != null && this._mediaElement.readyState !== 0) {\n          Promise.resolve().then(function () {\n            _this._emitter.emit(PlayerEvents.STATISTICS_INFO, _this.statisticsInfo);\n          });\n        }\n      }\n\n      this._emitter.addListener(event, listener);\n    }\n  }, {\n    key: \"off\",\n    value: function off(event, listener) {\n      this._emitter.removeListener(event, listener);\n    }\n  }, {\n    key: \"attachMediaElement\",\n    value: function attachMediaElement(mediaElement) {\n      this._mediaElement = mediaElement;\n      mediaElement.addEventListener('loadedmetadata', this.e.onvLoadedMetadata);\n\n      if (this._pendingSeekTime != null) {\n        try {\n          mediaElement.currentTime = this._pendingSeekTime;\n          this._pendingSeekTime = null;\n        } catch (e) {// IE11 may throw InvalidStateError if readyState === 0\n          // Defer set currentTime operation after loadedmetadata\n        }\n      }\n    }\n  }, {\n    key: \"detachMediaElement\",\n    value: function detachMediaElement() {\n      if (this._mediaElement) {\n        this._mediaElement.src = '';\n\n        this._mediaElement.removeAttribute('src');\n\n        this._mediaElement.removeEventListener('loadedmetadata', this.e.onvLoadedMetadata);\n\n        this._mediaElement = null;\n      }\n\n      if (this._statisticsReporter != null) {\n        window.clearInterval(this._statisticsReporter);\n        this._statisticsReporter = null;\n      }\n    }\n  }, {\n    key: \"load\",\n    value: function load() {\n      if (!this._mediaElement) {\n        throw new IllegalStateException('HTMLMediaElement must be attached before load()!');\n      }\n\n      this._mediaElement.src = this._mediaDataSource.url;\n\n      if (this._mediaElement.readyState > 0) {\n        this._mediaElement.currentTime = 0;\n      }\n\n      this._mediaElement.preload = 'auto';\n\n      this._mediaElement.load();\n\n      this._statisticsReporter = window.setInterval(this._reportStatisticsInfo.bind(this), this._config.statisticsInfoReportInterval);\n    }\n  }, {\n    key: \"unload\",\n    value: function unload() {\n      if (this._mediaElement) {\n        this._mediaElement.src = '';\n\n        this._mediaElement.removeAttribute('src');\n      }\n\n      if (this._statisticsReporter != null) {\n        window.clearInterval(this._statisticsReporter);\n        this._statisticsReporter = null;\n      }\n    }\n  }, {\n    key: \"play\",\n    value: function play() {\n      return this._mediaElement.play();\n    }\n  }, {\n    key: \"pause\",\n    value: function pause() {\n      this._mediaElement.pause();\n    }\n  }, {\n    key: \"_onvLoadedMetadata\",\n    value: function _onvLoadedMetadata(e) {\n      if (this._pendingSeekTime != null) {\n        this._mediaElement.currentTime = this._pendingSeekTime;\n        this._pendingSeekTime = null;\n      }\n\n      this._emitter.emit(PlayerEvents.MEDIA_INFO, this.mediaInfo);\n    }\n  }, {\n    key: \"_reportStatisticsInfo\",\n    value: function _reportStatisticsInfo() {\n      this._emitter.emit(PlayerEvents.STATISTICS_INFO, this.statisticsInfo);\n    }\n  }, {\n    key: \"type\",\n    get: function get() {\n      return this._type;\n    }\n  }, {\n    key: \"buffered\",\n    get: function get() {\n      return this._mediaElement.buffered;\n    }\n  }, {\n    key: \"duration\",\n    get: function get() {\n      return this._mediaElement.duration;\n    }\n  }, {\n    key: \"volume\",\n    get: function get() {\n      return this._mediaElement.volume;\n    },\n    set: function set(value) {\n      this._mediaElement.volume = value;\n    }\n  }, {\n    key: \"muted\",\n    get: function get() {\n      return this._mediaElement.muted;\n    },\n    set: function set(muted) {\n      this._mediaElement.muted = muted;\n    }\n  }, {\n    key: \"currentTime\",\n    get: function get() {\n      if (this._mediaElement) {\n        return this._mediaElement.currentTime;\n      }\n\n      return 0;\n    },\n    set: function set(seconds) {\n      if (this._mediaElement) {\n        this._mediaElement.currentTime = seconds;\n      } else {\n        this._pendingSeekTime = seconds;\n      }\n    }\n  }, {\n    key: \"mediaInfo\",\n    get: function get() {\n      var mediaPrefix = this._mediaElement instanceof HTMLAudioElement ? 'audio/' : 'video/';\n      var info = {\n        mimeType: mediaPrefix + this._mediaDataSource.type\n      };\n\n      if (this._mediaElement) {\n        info.duration = Math.floor(this._mediaElement.duration * 1000);\n\n        if (this._mediaElement instanceof HTMLVideoElement) {\n          info.width = this._mediaElement.videoWidth;\n          info.height = this._mediaElement.videoHeight;\n        }\n      }\n\n      return info;\n    }\n  }, {\n    key: \"statisticsInfo\",\n    get: function get() {\n      var info = {\n        playerType: this._type,\n        url: this._mediaDataSource.url\n      };\n\n      if (!(this._mediaElement instanceof HTMLVideoElement)) {\n        return info;\n      }\n\n      var hasQualityInfo = true;\n      var decoded = 0;\n      var dropped = 0;\n\n      if (this._mediaElement.getVideoPlaybackQuality) {\n        var quality = this._mediaElement.getVideoPlaybackQuality();\n\n        decoded = quality.totalVideoFrames;\n        dropped = quality.droppedVideoFrames;\n      } else if (this._mediaElement.webkitDecodedFrameCount != undefined) {\n        decoded = this._mediaElement.webkitDecodedFrameCount;\n        dropped = this._mediaElement.webkitDroppedFrameCount;\n      } else {\n        hasQualityInfo = false;\n      }\n\n      if (hasQualityInfo) {\n        info.decodedFrames = decoded;\n        info.droppedFrames = dropped;\n      }\n\n      return info;\n    }\n  }]);\n\n  return NativePlayer;\n}();\n\nexport default NativePlayer;","map":null,"metadata":{},"sourceType":"module"}